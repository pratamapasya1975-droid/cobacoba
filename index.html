<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ABRAR-QU QR Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  
  <style>
    :root{
      --bg: #030712; --card-bg: rgba(31, 41, 55, 0.8);
      --primary: #10b981; --secondary: #3b82f6;
      --text: #f3f4f6; --muted: #9ca3af; --radius: 16px;
    }
    body{
      margin: 0; background-color: var(--bg); color: var(--text);
      font-family: 'Inter', sans-serif; min-height: 100vh;
    }
    .container{ max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header{
      display: flex; align-items: center; gap: 15px; padding: 20px;
      background: var(--card-bg); border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
    }
    .logo-img { width: 50px; height: 50px; border-radius: 10px; border: 2px solid var(--primary); }
    .grid{ display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
    .card{
      background: var(--card-bg); padding: 20px; border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1);
    }
    /* QR BOX */
    #qrcode { background: #fff; padding: 15px; border-radius: 12px; display: inline-block; margin: 15px 0; }
    #reader { width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid var(--primary); display: none; margin-bottom: 15px; }
    /* TABLE */
    .table-wrapper { overflow-y: auto; max-height: 500px; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th { position: sticky; top: 0; background: #111827; padding: 12px; color: var(--primary); text-align: left; }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
    .btn {
      padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px;
    }
    .btn-camera { background: var(--primary); color: #000; }
    @media print { .header, .btn, .grid > :first-child { display: none; } body { color: black; background: white; } }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="logo.jpg" alt="Logo" class="logo-img">
    <div style="flex-grow: 1;">
      <h1 style="margin:0; font-size: 20px;">ABRAR-QU <span style="color: var(--primary);">QR SYSTEM</span></h1>
      <small id="syncStatus" style="color:var(--muted)">Menghubungkan ke Python...</small>
    </div>
    <button class="btn" style="width:auto; background:var(--secondary); color:white" onclick="window.print()">Cetak</button>
  </div>

  <div class="grid">
    <div class="card" style="text-align: center;">
      <h3 style="margin-top:0">Scan Point</h3>
      <div id="reader"></div>
      <button class="btn btn-camera" id="startCamBtn">ðŸ“¸ Buka Kamera Absen</button>
      <button class="btn" id="stopCamBtn" style="display:none; background:#ef4444; color:white;">ðŸ›‘ Tutup Kamera</button>

      <div style="margin: 15px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <small style="color:var(--muted)">ID PERANGKAT ANDA:</small><br>
        <div id="qrcode"></div>
        <div id="tokenText" style="font-family: monospace; font-weight: bold; color: var(--primary);"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0">Log Kehadiran Real-Time</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>WAKTU</th><th>ID USER</th><th>METODE</th></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const SERVER_URL = "http://" + window.location.hostname + ":5000";
  let html5QrCode;

  // 1. Generate QR Code untuk Perangkat Ini
  function initQR() {
    let id = localStorage.getItem('abrar_token') || "AQ-" + Math.random().toString(36).substr(2, 7).toUpperCase();
    localStorage.setItem('abrar_token', id);
    document.getElementById('tokenText').innerText = id;
    new QRCode(document.getElementById("qrcode"), { text: id, width: 150, height: 150 });
  }

  // 2. Fungsi Kirim Absen ke Python
  async function processAttendance(scannedID, method = "QR_CAM") {
    if (window.lastScan === scannedID && Date.now() - window.lastScanTime < 3000) return;
    window.lastScan = scannedID; window.lastScanTime = Date.now();

    new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play();
    
    try {
      await fetch(`${SERVER_URL}/api/scan`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: scannedID, metode: method })
      });
      loadHistory();
    } catch (err) { console.error("Offline"); }
  }

  // 3. Ambil Data History dari Python
  async function loadHistory() {
    try {
      const res = await fetch(`${SERVER_URL}/api/history`);
      const data = await res.json();
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = data.map(item => `
        <tr>
          <td>${item.waktu.split(' ')[1]}</td>
          <td><code style="color:var(--secondary)">${item.user_id}</code></td>
          <td><small>${item.metode}</small></td>
        </tr>
      `).join('');
      document.getElementById('syncStatus').innerText = "âœ“ Server Connected";
    } catch (e) { document.getElementById('syncStatus').innerText = "âœ• Server Offline"; }
  }

  // 4. Kamera Logic (QR Code Mode)
  document.getElementById('startCamBtn').onclick = () => {
    document.getElementById('reader').style.display = 'block';
    document.getElementById('startCamBtn').style.display = 'none';
    document.getElementById('stopCamBtn').style.display = 'block';

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 },
      (decodedText) => processAttendance(decodedText)
    );
  };

  document.getElementById('stopCamBtn').onclick = () => {
    html5QrCode.stop().then(() => {
      document.getElementById('reader').style.display = 'none';
      document.getElementById('startCamBtn').style.display = 'block';
      document.getElementById('stopCamBtn').style.display = 'none';
    });
  };

  initQR();
  setInterval(loadHistory, 3000);
  loadHistory();
</script>
</body>
</html>
